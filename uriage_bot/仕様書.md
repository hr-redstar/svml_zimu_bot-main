# 📝 売上報告Bot (uriage_bot) 仕様書

## 1. 概要

本Botは、Discord上で日々の売上報告を円滑に行うためのツールです。
ユーザーは簡単なコマンド操作とフォーム入力だけで報告を完了でき、報告データはGoogle Cloud Storage (GCS) に安全に蓄積されます。

### 主な機能
- スラッシュコマンドによる売上報告UIの設置
- モーダル（フォーム）ベースの直感的な売上報告・修正機能
- Google Cloud Storage (GCS) へのデータ永続化
- 報告の上書き時に自動でバックアップ（ログ）を作成
- 報告メッセージの動的な更新
- （将来的な拡張）承認ワークフローの基盤

---

## 2. 機能仕様

### 2.1. コマンド

#### `/売上報告設置`
- **説明**: 売上報告を開始するためのUI（Embedメッセージとボタン）を、コマンドが実行されたチャンネルに設置します。
- **引数**: なし
- **実行結果**:
  - **Embed**: 売上報告の入力項目例（日付、総売り、現金、カード、諸経費）が表示されます。
  - **ボタン**:
    - `売上報告`: 新規に報告を行うためのモーダルを起動します。
    - `報告を修正`: 過去の報告を修正するためのフローを開始します。

### 2.2. 売上報告フロー

1.  ユーザーが `/売上報告設置` で設置されたメッセージの「売上報告」ボタンをクリックします。
2.  売上報告用のモーダル (`sales_report_modal`) が表示されます。
    - **入力項目**:
      - `日付` (必須, 例: 7/23)
      - `総売り` (必須, 半角数字)
      - `現金` (必須, 半角数字)
      - `カード` (必須, 半角数字)
      - `諸経費` (必須, 半角数字)
3.  ユーザーが情報を入力し「送信」をクリックします。
4.  Botは入力値を検証し、残金（総売り - カード - 諸経費）を自動計算します。
5.  検証が成功すると、コマンド実行チャンネルに報告内容をまとめたEmbedメッセージを投稿します。
6.  投稿されたメッセージには「次の売上を報告」ボタンが付属します。
7.  同時に、報告内容はGCSにJSONファイルとして保存されます。（詳細は「3. データ仕様」を参照）

### 2.3. 売上修正フロー

1.  ユーザーが `/売上報告設置` で設置されたメッセージの「報告を修正」ボタンをクリックします。
2.  （未実装）Botはユーザーが過去に報告したデータの一覧を提示します（例: セレクトメニュー）。
3.  ユーザーが修正したい報告を選択します。
4.  選択された報告のデータが事前入力されたモーダル (`edit_sales_report_modal`) が表示されます。
5.  ユーザーが内容を修正し「送信」をクリックします。
6.  Botは元の報告メッセージを新しい内容で編集・更新します。
7.  GCSに保存されている対応するJSONファイルも新しい内容で上書き更新されます。
    - 日付が変更された場合、古い日付のファイルは削除され、新しい日付でファイルが作成されます。

---

## 3. データ仕様

報告データはすべてGoogle Cloud Storageに保存されます。

- **保存先**: Google Cloud Storage
- **バケット名**: 環境変数 `GCS_BUCKET_NAME` で指定

### 3.1. 売上報告データ

- **ファイルパス**: `data/sales_reports/{guildId}/uriage-houkoku-{YYYY-MM-DD}-{userId}.json`
- **フォーマット**: JSON
- **データ構造**:
  ```json
  {
    "入力者": "user_name",
    "userId": "123456789012345678",
    "日付": "2023-07-23",
    "総売り": 300000,
    "現金": 150000,
    "カード": 100000,
    "諸経費": 50000,
    "残金": 150000,
    "登録日時": "2023-07-23T10:00:00.000Z",
    "messageId": "987654321098765432"
  }
  ```

### 3.2. バックアップ（ログ）データ

既存の報告を上書き修正する際に、古いデータがバックアップとして保存されます。

- **ファイルパス**: `logs/sales_reports/{guildId}/uriage-houkoku-{YYYY-MM-DD}-{userId}_{timestamp}.json`
- **フォーマット**: JSON (構造は上記と同じ)

---

## 4. 技術・運用仕様

- **主要ライブラリ**: `discord.js` v14, `@google-cloud/storage`
- **実行環境**: Node.js (v18.x 推奨)
- **プロセス管理**: PM2 (`ecosystem.config.js` で設定)
- **環境変数**: BotトークンやGCSバケット名などを `.env` ファイルで管理
- **サーバー運用**:
  - 初期セットアップは `init_server.sh` で自動化。
  - Botのコード更新は `update.sh` で実施。
  - 詳細な手順は `運用手順書.md` を参照。