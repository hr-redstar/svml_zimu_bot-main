# 📘 売上報告Bot サーバー運用手順書

## ✅ 目的

Google Cloud インスタンス上で稼働する Discord Bot「uriage_bot」の「更新」「初期化」「データ管理」作業を安全かつ再現性高く行うための手順をまとめます。

---

## 🚀 1. 新規サーバーへの初期セットアップ

まっさらなサーバーに初めてBotを導入する場合、`init_server.sh` スクリプトを使用します。

**注意:** このスクリプトは**一度だけ**実行してください。既存の環境で実行するとエラーになります。

```bash
# 1. ホームディレクトリに移動
cd ~

# 2. スクリプトをダウンロードまたは配置
# (例: git clone または scp でサーバーに転送)

# 3. スクリプトに実行権限を付与
chmod +x init_server.sh

# 4. スクリプトを実行
./init_server.sh
```

スクリプトは以下の処理を自動で行います。
- タイムゾーン設定、パッケージ更新
- Node.js, PM2 のインストール
- GitHubからのリポジトリクローン
- `.env` ファイルの準備
- 依存パッケージのインストール
- Discordスラッシュコマンドの登録
- PM2によるBotの起動と自動起動設定

実行後、画面の指示に従って `.env` ファイルの編集と、PM2の自動起動コマンドを実行してください。

---

## 📦 2. Botの更新手順

コードの変更をサーバーに反映させる場合、`update.sh` スクリプト（リポジトリ内に存在する場合）または手動での更新を行います。

### 2-1. `update.sh` スクリプトを使用する場合 (推奨)

```bash
# 1. プロジェクトディレクトリに移動
cd ~/uriage_bot

# 2. 更新スクリプトを実行
./update.sh
```
> `update.sh` がない場合は、手動手順を参照するか、`keihi_bot` の `update_bot.sh` を参考に作成してください。

### 2-2. 手動での更新手順

`update.sh` がない場合や、特定のファイルを差し替えたい場合の手順です。

```bash
# 1. Botを停止
cd ~/uriage_bot
pm2 stop uriage-bot

# 2. 最新のコードを取得
git pull origin main # またはZIPファイルを展開して上書き

# 3. 依存関係を更新
npm install --no-audit --no-fund

# 4. スラッシュコマンドを再登録 (コマンド定義に変更があった場合)
node deploy-commands.js

# 5. Botを再起動
pm2 restart uriage-bot

# 6. PM2のプロセスリストを保存 (サーバー再起動時に設定を維持するため)
pm2 save
```

---

## 💾 3. データ管理 (バックアップと復元)

`uriage_bot` の売上報告データは、すべて **Google Cloud Storage (GCS)** に保存されます。

- **バックアップ**:
  - GCSの「オブジェクトのバージョニング」機能を有効にすることで、上書きや削除からデータを保護できます。
  - 定期的なバックアップが必要な場合は、GCSのコンソールから手動でフォルダをコピーするか、`gsutil` コマンドやCloud Functionsで自動化します。
- **復元**:
  - バージョニングが有効な場合、古いバージョンのオブジェクトを復元できます。
  - 手動バックアップから復元する場合は、GCS上のファイルを上書きします。

**ローカルファイル (`~/uriage_bot/logs`)**:
- これらはBotの動作ログであり、売上データそのものではありません。
- トラブルシューティングに役立ちますが、定期的なバックアップは必須ではありません。必要に応じて手動でコピーしてください。

---

## 🛠️ 4. よく使うPM2コマンド

```bash
# Botの状態を確認
pm2 status

# Botのログをリアルタイムで表示
pm2 logs uriage-bot

# Botを停止
pm2 stop uriage-bot

# Botを起動
pm2 start uriage-bot

# Botを再起動
pm2 restart uriage-bot
```